<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PennyWise - Khatabook Tracker & Games</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
  --bg: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --card-bg: rgba(255,255,255,0.95);
  --text:#222; --muted:#555;
  --good:#1b8a2a; --bad:#c62828;
  --btn1:#4facfe; --btn2:#00f2fe;
}
body.dark{
  --bg: #0f172a; --card-bg: rgba(15,23,42,0.85);
  --text:#e5e7eb; --muted:#9ca3af;
  --good:#22c55e; --bad:#ef4444;
  --btn1:#6366f1; --btn2:#22d3ee;
}
*{box-sizing:border-box;}
body{
  margin:0; padding:0; font-family:'Poppins',sans-serif;
  background: var(--bg); color: var(--text); min-height:100vh;
}
header{
  display:flex; justify-content:space-between; align-items:center;
  padding:15px 20px; font-size:1.6rem; font-weight:700; color:white;
}
header .brand{display:flex; align-items:center;}
header .actions button{
  background:none; border:none; color:white; cursor:pointer; font-size:1.2rem;
}
.container{max-width:900px;margin:0 auto;padding:10px;}
.card{background:var(--card-bg);border-radius:15px;padding:20px;margin-bottom:15px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
.card h2{margin-top:0;color:#111;}
input, select, textarea, button{width:100%;padding:10px;margin:8px 0;border-radius:10px;border:1px solid #ccc;font-size:1rem;}
button{background:linear-gradient(135deg,var(--btn1),var(--btn2));color:white;font-weight:600;cursor:pointer;transition:0.2s;}
button:hover{opacity:0.85;}
.transaction-list{max-height:300px;overflow-y:auto;}
.transaction{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid rgba(0,0,0,0.1);}
.transaction.credit{color:var(--good);}
.transaction.debit{color:var(--bad);}
.summary{display:flex;justify-content:space-around;padding:10px;font-weight:700;}
.summary div{flex:1;text-align:center;background:rgba(0,0,0,0.05);border-radius:10px;padding:10px;margin:5px;}
.table-container{overflow-x:auto;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
table, th, td{border:1px solid #ccc;}
th,td{padding:8px;text-align:center;}
.small{font-size:0.85rem;color:var(--muted);}
.ai-advice{margin-top:10px;padding:10px;border-left:4px solid var(--btn2);background:rgba(0,0,0,0.03);}
.flex{display:flex;gap:10px;flex-wrap:wrap;}
.flex input,.flex select{flex:1;}
/* Games layout */
.games{display:flex;flex-wrap:wrap;gap:15px;}
.game-card{flex:1;min-width:250px;background:var(--card-bg);padding:15px;border-radius:15px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,0.1);}
.progress-bar{background:#ccc;border-radius:10px;overflow:hidden;margin-top:5px;}
.progress-fill{height:20px;background:var(--btn2);width:0%;text-align:center;color:#fff;line-height:20px;font-weight:600;}
</style>
</head>
<body>

<header>
  <div class="brand">üí∞ PennyWise</div>
  <div class="actions">
    <button id="themeToggle">üåô Dark</button>
  </div>
</header>

<div class="container" id="mainContainer" style="display:none;">

<!-- Welcome -->
<div class="card" id="welcomeCard">
<h2 id="welcomeText">Welcome!</h2>
</div>

<!-- Month / Year Filter -->
<div class="card">
<h2>üìÖ View by Month / Year</h2>
<div class="flex">
<select id="monthSelect">
<option value="">All Months</option>
<option value="01">January</option>
<option value="02">February</option>
<option value="03">March</option>
<option value="04">April</option>
<option value="05">May</option>
<option value="06">June</option>
<option value="07">July</option>
<option value="08">August</option>
<option value="09">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
<select id="yearSelect">
<option value="">All Years</option>
</select>
</div>
<button onclick="applyMonthYearFilter()">Apply</button>
</div>

<!-- Add Transaction -->
<div class="card">
<h2>‚ûï Add / Edit Transaction</h2>
<div class="flex">
<input type="text" id="party" placeholder="Party / Person Name">
<select id="type">
<option value="credit">Sent</option>
<option value="debit">Got</option>
</select>
<input type="number" id="amount" placeholder="Amount">
<input type="date" id="date">
</div>
<textarea id="desc" placeholder="Description (optional)"></textarea>
<div class="flex">
<button onclick="addTransaction()">Add / Update</button>
<label class="small" style="cursor:pointer;">Import CSV <input type="file" id="importCSV" style="display:none" onchange="importFromCSV(event)"></label>
<button onclick="exportToCSV()">Export CSV</button>
<button onclick="exportToPDF()">Export PDF</button>
<button onclick="exportToExcel()">Export Excel</button>
</div>
</div>

<!-- Filters -->
<div class="card">
<h2>üîç Filters</h2>
<div class="flex">
<input id="qParty" placeholder="Search Party / Person">
<select id="qType">
<option value="">All</option>
<option value="credit">Sent</option>
<option value="debit">Got</option>
</select>
<input id="qMin" type="number" placeholder="Min Amount">
<input id="qMax" type="number" placeholder="Max Amount">
<input id="qFrom" type="date" placeholder="From Date">
<input id="qTo" type="date" placeholder="To Date">
</div>
<div class="flex">
<button onclick="applyFilters()">Apply</button>
<button onclick="clearFilters()">Clear</button>
</div>
<p class="small">Filters apply to both transaction list and summary.</p>
</div>

<!-- Summary -->
<div class="card">
<h2>üìä Summary</h2>
<div class="summary">
<div id="totalCredit">Sent: ‚Çπ0</div>
<div id="totalDebit">Got: ‚Çπ0</div>
<div id="balance">Balance: ‚Çπ0</div>
</div>
<!-- Salary Progress -->
<div class="card">
<h3>üíµ Salary vs Expenses</h3>
<input type="number" id="salaryInput" placeholder="Optional: Enter Monthly Salary">
<button onclick="updateSalaryProgress()">Update Progress</button>
<div class="progress-bar">
<div id="salaryProgress" class="progress-fill">0%</div>
</div>
</div>
</div>

<!-- Transaction List -->
<div class="card">
<h2>üìù Transactions</h2>
<div class="transaction-list" id="transactions"></div>
</div>

<!-- AI Summary -->
<div class="card">
<h2>ü§ñ AI Expense Summary</h2>
<div class="flex">
<button onclick="generateAISummary()">Generate AI Summary</button>
</div>
<div class="table-container">
<table id="aiSummaryTable">
<thead>
<tr><th>Party</th><th>Sent</th><th>Got</th><th>Description</th><th>Date</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="ai-advice" id="aiAdvice">Enter salary for personalized advice.</div>
</div>

<!-- Mini-Games -->
<div class="card">
<h2>üéÆ Mini Games</h2>
<div class="games">
<div class="game-card">
<h3>Dice Roll üé≤</h3>
<button onclick="rollDice()">Roll Dice</button>
<p id="diceResult"></p>
</div>
<div class="game-card">
<h3>Coin Flip ü™ô</h3>
<button onclick="flipCoin()">Flip Coin</button>
<p id="coinResult"></p>
</div>
<div class="game-card">
<h3>Number Guess üéØ</h3>
<input type="number" id="guessNumberInput" placeholder="Guess 1-10">
<button onclick="guessNumber()">Guess</button>
<p id="guessResult"></p>
</div>
</div>
</div>

</div>

<!-- PIN / Name Setup & Login -->
<div class="card" id="loginCard">
<h2>üîê Enter PIN</h2>
<div class="flex">
<input type="text" id="userName" placeholder="Your Name (First time)">
<input type="password" id="userPin" placeholder="4-digit PIN">
</div>
<div class="flex">
<button onclick="login()">Login / Set PIN</button>
<button onclick="recoverPin()">Recover PIN</button>
</div>
<div class="small" id="loginMsg"></div>
</div>

<script>
// ===== Base Setup =====
let transactions = JSON.parse(localStorage.getItem('transactions')||'[]');
let editIndex = null;
const themeBtn=document.getElementById('themeToggle');
themeBtn.onclick=()=>{document.body.classList.toggle('dark'); themeBtn.textContent=document.body.classList.contains('dark')?'‚òÄÔ∏è Light':'üåô Dark';}

// ===== PIN/Login =====
function login(){
  let name = document.getElementById('userName').value.trim();
  let pin = document.getElementById('userPin').value.trim();
  let storedPin = localStorage.getItem('pin');
  let storedName = localStorage.getItem('userName');

  if(!storedPin){ // First-time setup
    if(!name || !pin || pin.length!==4){document.getElementById('loginMsg').textContent='Enter name & 4-digit PIN'; return;}
    localStorage.setItem('pin', pin); localStorage.setItem('userName', name);
    localStorage.setItem('securityAnswer', prompt('Set security answer for PIN recovery (e.g., favorite color)').trim());
    enterApp(name);
  } else {
    if(pin === storedPin){enterApp(storedName);}
    else{document.getElementById('loginMsg').textContent='Incorrect PIN';}
  }
}
function recoverPin(){
  let answer = prompt('Enter your security answer to reset PIN:').trim();
  let storedAnswer = localStorage.getItem('securityAnswer');
  if(answer === storedAnswer){
    let newPin = prompt('Enter new 4-digit PIN:').trim();
    if(newPin.length===4){localStorage.setItem('pin', newPin); alert('PIN reset successful');}
    else{alert('PIN must be 4 digits');}
  } else alert('Wrong security answer');
}
function enterApp(name){
  document.getElementById('loginCard').style.display='none';
  document.getElementById('mainContainer').style.display='block';
  document.getElementById('welcomeText').textContent=`Welcome, ${name}!`;
  populateYearSelect();
  renderTransactions();
  updateSalaryProgress();
}

// ===== Populate Year dropdown =====
function populateYearSelect(){
  let years = [...new Set(transactions.map(t=>t.date.split('-')[0]))];
  let yearSelect=document.getElementById('yearSelect');
  years.forEach(y=>{
    if(!Array.from(yearSelect.options).some(opt=>opt.value===y)){
      let o = document.createElement('option'); o.value=y; o.textContent=y; yearSelect.appendChild(o);
    }
  });
}

// ===== Month/Year Filter =====
function applyMonthYearFilter(){
  const month=document.getElementById('monthSelect').value;
  const year=document.getElementById('yearSelect').value;
  renderTransactions(t=>{if(month && t.date.split('-')[1]!==month) return false; if(year && t.date.split('-')[0]!==year) return false; return true;});
}

// ===== Transaction Functions =====
function addTransaction(){
const party=document.getElementById('party').value.trim();
const type=document.getElementById('type').value;
const amount=parseFloat(document.getElementById('amount').value);
const date=document.getElementById('date').value;
const desc=document.getElementById('desc').value.trim();
if(!party||!amount||!date){alert('Please fill required fields');return;}
const tx={party,type,amount,date,desc};
if(editIndex!==null){transactions[editIndex]=tx;editIndex=null;}else{transactions.push(tx);}
transactions.sort((a,b)=>new Date(a.date)-new Date(b.date));
localStorage.setItem('transactions',JSON.stringify(transactions));
populateYearSelect();
document.getElementById('party').value='';document.getElementById('amount').value='';document.getElementById('date').value='';document.getElementById('desc').value='';
renderTransactions();
updateSalaryProgress();
}

function editTransaction(i){const t=transactions[i];document.getElementById('party').value=t.party;document.getElementById('type').value=t.type;document.getElementById('amount').value=t.amount;document.getElementById('date').value=t.date;document.getElementById('desc').value=t.desc;editIndex=i;}
function deleteTransaction(i){if(confirm('Delete this transaction?')){transactions.splice(i,1);localStorage.setItem('transactions',JSON.stringify(transactions));renderTransactions();updateSalaryProgress();}}

function applyFilters(){renderTransactions();}
function clearFilters(){document.getElementById('qParty').value='';document.getElementById('qType').value='';document.getElementById('qMin').value='';document.getElementById('qMax').value='';document.getElementById('qFrom').value='';document.getElementById('qTo').value='';renderTransactions();}

function renderTransactions(extraFilter){
const list=document.getElementById('transactions');list.innerHTML='';
let totalCredit=0,totalDebit=0;
const fp=transactions.filter(t=>{
const qParty=document.getElementById('qParty').value.trim().toLowerCase();
const qType=document.getElementById('qType').value;
const qMin=document.getElementById('qMin').value;
const qMax=document.getElementById('qMax').value;
const qFrom=document.getElementById('qFrom').value;
const qTo=document.getElementById('qTo').value;
if(extraFilter && !extraFilter(t)) return false;
if(qParty && !t.party.toLowerCase().includes(qParty))return false;
if(qType && t.type!==qType)return false;
if(qMin && t.amount<parseFloat(qMin))return false;
if(qMax && t.amount>parseFloat(qMax))return false;
if(qFrom && t.date<qFrom)return false;
if(qTo && t.date>qTo)return false;
return true;
});
fp.forEach((t,i)=>{
const div=document.createElement('div');div.className='transaction '+(t.type==='credit'?'credit':'debit');
div.innerHTML=`<div><strong>${t.party}</strong> (${t.type==='credit'?'Sent':'Got'} ‚Çπ${t.amount})<br><span class="small">${t.desc||''} | ${t.date}</span></div>
<div><button onclick="editTransaction(${i})">Edit</button> <button onclick="deleteTransaction(${i})">Delete</button></div>`;
list.appendChild(div);
if(t.type==='credit')totalCredit+=t.amount;else totalDebit+=t.amount;
});
document.getElementById('totalCredit').textContent=`Sent: ‚Çπ${totalCredit}`;
document.getElementById('totalDebit').textContent=`Got: ‚Çπ${totalDebit}`;
document.getElementById('balance').textContent=`Balance: ‚Çπ${(totalDebit-totalCredit)}`;
generateAISummary();
}

// ===== Export / Import =====
function exportToCSV(){let csv='Party,Type,Amount,Date,Description\n';transactions.forEach(t=>{csv+=`${t.party},${t.type},${t.amount},${t.date},"${t.desc}"\n`});const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='transactions.csv';a.click();}
function importFromCSV(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(ev){const lines=ev.target.result.split('\n').slice(1);lines.forEach(line=>{if(!line.trim())return;const [party,type,amount,date,desc]=line.split(',');if(!party||!type||!amount||!date)return;transactions.push({party,type,amount:parseFloat(amount),date,desc});});transactions.sort((a,b)=>new Date(a.date)-new Date(b.date));localStorage.setItem('transactions',JSON.stringify(transactions));populateYearSelect();renderTransactions();};reader.readAsText(file);}
function exportToPDF(){const { jsPDF }=window.jspdf;const doc=new jsPDF();doc.text('PennyWise Transactions',10,10);let y=20;transactions.forEach(t=>{doc.text(`${t.date} | ${t.party} | ${t
.type==='credit'?'Sent':'Got'} ‚Çπ${t.amount} | ${t.desc}`,10,y);y+=8;if(y>280){doc.addPage();y=10;}});doc.save('transactions.pdf');}
function exportToExcel(){const wb=XLSX.utils.book_new();const ws=XLSX.utils.json_to_sheet(transactions);XLSX.utils.book_append_sheet(wb,ws,'Transactions');XLSX.writeFile(wb,'transactions.xlsx');}

// ===== AI Summary =====
function generateAISummary(){
const salary=parseFloat(document.getElementById('salaryInput').value);
const tbody=document.querySelector('#aiSummaryTable tbody');tbody.innerHTML='';
transactions.forEach(t=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${t.party}</td><td>${t.type==='credit'?t.amount:'-'}</td><td>${t.type==='debit'?t.amount:'-'}</td><td>${t.desc}</td><td>${t.date}</td>`;tbody.appendChild(tr);});
let totalSent=transactions.filter(t=>t.type==='credit').reduce((a,b)=>a+b.amount,0);
let totalGot=transactions.filter(t=>t.type==='debit').reduce((a,b)=>a+b.amount,0);
let advice='';
if(!salary)advice='üí° Optional: Enter salary for personalized advice.';
else{const remaining=salary-totalSent;if(totalSent>salary*0.7)advice=`‚ö†Ô∏è Your total sent exceeds 70% of salary. Try reducing unnecessary expenses. Remaining approx ‚Çπ${remaining}.`;else advice=`‚úÖ Spending under control. Approx remaining ‚Çπ${remaining}.`;}
document.getElementById('aiAdvice').textContent=advice;
updateSalaryProgress();
}

// ===== Salary Progress Bar =====
function updateSalaryProgress(){
const salary=parseFloat(document.getElementById('salaryInput').value);
let totalSent=transactions.filter(t=>t.type==='credit').reduce((a,b)=>a+b.amount,0);
let perc = salary ? Math.min(100, Math.round((totalSent/salary)*100)) : 0;
document.getElementById('salaryProgress').style.width=perc+'%';
document.getElementById('salaryProgress').textContent=salary ? perc+'%' : '0%';
}

// ===== Mini Games =====
function rollDice(){let n=Math.floor(Math.random()*6)+1;document.getElementById('diceResult').textContent=`You rolled: ${n}`;}
function flipCoin(){let c=Math.random()<0.5?'Heads':'Tails';document.getElementById('coinResult').textContent=`${c}`;}
function guessNumber(){let guess=parseInt(document.getElementById('guessNumberInput').value);let n=Math.floor(Math.random()*10)+1;if(guess===n)document.getElementById('guessResult').textContent='üéâ Correct!';else document.getElementById('guessResult').textContent=`‚ùå Wrong! Number was ${n}`;}
</script>
</body>
</html>
